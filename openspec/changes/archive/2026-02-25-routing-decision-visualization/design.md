## Context

当前请求日志页面的路由决策信息展示存在以下问题：

1. **信息零散**：决策信息分布在多个小图标和两列布局中，用户需要"拼凑"才能理解决策过程
2. **亲和性不可见**：虽然后端计算了 `affinityHit` 和 `affinityMigrated`，但这些信息未被持久化，前端无法展示
3. **重试过程黑盒**：`failoverHistory` 记录了每次失败尝试，但在展开视图中完全没有展示
4. **缺乏叙事性**：用户无法一眼看懂"为什么选这个上游"、"是否发生迁移"、"重试了几次"

已有的 `session-affinity` 变更为我们提供了亲和性计算能力，本变更专注于**将这些信息以清晰、直观的方式呈现给用户**。

## Goals / Non-Goals

**Goals:**
- 采用时间线叙事布局，让用户按顺序理解决策过程（模型解析 → 亲和性评估 → 上游选择 → 执行重试 → 最终结果）
- 持久化并展示亲和性绑定状态、迁移决策、会话标识
- 可视化故障转移过程，展示每次尝试的时间戳、上游、错误类型、耗时
- 保持 Cassette Futurism 视觉风格的一致性
- 向后兼容：不影响现有日志数据的展示

**Non-Goals:**
- 不修改亲和性计算逻辑（已在 session-affinity 中完成）
- 不添加新的路由策略或负载均衡算法
- 不实现实时推送或 WebSocket 更新
- 不添加复杂的查询筛选功能（如按 sessionId 筛选日志）

## Decisions

### 1. 时间线布局 vs 表格/卡片布局

**决策**：采用垂直时间线布局，按阶段展示决策过程。

**理由**：
- 路由决策是**时序过程**（先解析模型，再评估亲和性，再选择上游，最后执行），时间线符合心智模型
- 每个阶段的信息密度不同，时间线允许灵活调整每个阶段的高度
- 与终端/监控系统的日志输出风格一致，符合 Cassette Futurism 美学

**替代方案考虑**：
- 表格布局：适合对比多行数据，但不适合展示单条请求的决策过程
- 卡片网格：信息密度高，但阶段之间的因果关系不清晰

### 2. 数据库字段扩展 vs JSON 字段存储

**决策**：在 `request_logs` 表新增独立字段（`session_id`, `affinity_hit`, `affinity_migrated`）。

**理由**：
- 这些字段需要被频繁查询和索引（如后续按 sessionId 筛选）
- 字段语义明确，不会动态变化，适合用独立字段
- 与现有 `failover_attempts` 等字段保持一致性

**替代方案考虑**：
- JSON 字段存储：灵活但查询性能差，不适合高频筛选场景

### 3. 故障转移耗时计算方式

**决策**：单独计算 `failover_duration_ms`（从首次失败到最终成功的时间），与 `duration_ms`（总请求耗时）区分。

**理由**：
- 故障转移耗时是路由决策质量的指标，需要单独监控
- 总耗时包含上游响应时间，不能准确反映故障转移开销

**计算方式**：
```
failover_duration_ms = last_success_time - first_failover_attempt_time
```

### 4. 组件重构方式

**决策**：完全重写 `RoutingDecisionDisplay` 组件，但保持 Props 接口向后兼容。

**理由**：
- 现有组件的两列布局与时间线布局差异太大，渐进式修改成本高
- 保持 Props 接口兼容（`routingDecision`, `upstreamName` 等字段不变），确保 `logs-table.tsx` 无需大幅修改

### 5. 视觉设计

**决策**：
- 阶段标题使用 `① ② ③` 数字圆圈 + 大写字母
- 成功状态用绿色 ✓，失败用红色 ⚡，选中用琥珀色 ●
- 时间戳使用等宽字体，右对齐
- 会话 ID 截断显示，hover 显示完整值

**理由**：
- 数字圆圈明确指示阶段顺序
- 颜色编码符合现有设计系统（`--status-success`, `--status-error`）
- 等宽字体对齐时间戳，便于快速扫描

## UI Wireframes

### 当前布局（问题分析）

```
紧凑视图：
├─ 上游名称
├─ 路由类型 badge + 候选数
└─ 图标区（重定向? 故障转移? 排除?）    ← 信息分散，无叙事性

展开视图：
├─ 左上：模型解析（原始 → 解析后）     ← 孤立的信息块
├─ 右上：策略名称                        ← 缺乏上下文
├─ 左下：候选列表（名字+权重+熔断状态）  ← 无法看出选择原因
└─ 右下：被排除列表                      ← 亲和性、重试信息完全缺失
```

### 新设计：紧凑视图

在表格行内展示决策链条摘要和关键指示器：

```
┌─────────────────────────────────────────────────────────────┐
│  [上游图标] rc                                                │
│  [决策链] 自动路由 → 分层选择 → 亲和绑定                      │
│  [指标] 2/3候选 │ ⚡故障转移(2) │ 🔗绑定命中                  │
└─────────────────────────────────────────────────────────────┘
```

紧凑视图的改进点：
- 新增决策链条摘要，一行概括决策过程
- 亲和性指示器（🔗绑定命中 / ↗️迁移）与故障转移指示器并列
- 故障转移次数直接显示

### 新设计：展开视图 - 完整决策时间线

点击展开后，按 5 个阶段展示完整决策过程：

```
┌────────────────────────────────────────────────────────────────────┐
│  ROUTING DECISION TIMELINE                                          │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ① MODEL RESOLUTION                                                │
│  ┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄ │
│    gpt-5.3-codex ──→ gpt-5.3-codex  (无重定向)                     │
│                                                                     │
│  ② SESSION AFFINITY                                                │
│  ┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄ │
│    会话ID: 550e8400-e29b-41d4-a716-446655440000                    │
│    状态: 🔗 命中绑定  (原绑定上游: rc)                              │
│    [迁移评估] 累计Token: 15,234 < 阈值50,000 ✓                     │
│    决策: ↗️ 迁移至更高优先级上游: premium-openai                    │
│                                                                     │
│  ③ UPSTREAM SELECTION                                              │
│  ┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄ │
│    ● premium-openai  [closed]  w:10  ← 选中                       │
│    ○ rc              [closed]  w:5                                  │
│    ✗ backup-openai   [open]    w:3   熔断排除                      │
│                                                                     │
│  ④ EXECUTION & RETRIES                                             │
│  ┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄ │
│    Attempt 1                                                        │
│      14:32:01.234  premium-openai  ● 选中                          │
│      14:32:03.567  ⚡ HTTP 503  →  触发故障转移                     │
│      耗时: 2.333s                                                   │
│                                                                     │
│    Attempt 2                                                        │
│      14:32:03.589  rc  ● 选中                                      │
│      14:32:04.123  ⚡ Timeout  →  触发故障转移                      │
│      耗时: 0.534s                                                   │
│                                                                     │
│    Attempt 3  ✓ SUCCESS                                             │
│      14:32:04.145  backup-openai  ● 选中                           │
│      14:32:06.890  ✓ 200 OK                                        │
│      耗时: 2.745s                                                   │
│                                                                     │
│    ─────────────────────────────────────────────────────            │
│    故障转移耗时: 3.656s  (2 次失败 → 第 3 次成功)                    │
│                                                                     │
│  ⑤ FINAL RESULT                                                    │
│  ┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄ │
│    成功上游: backup-openai                                          │
│    总耗时: 5.656s                                                   │
│    缓存效果: 本次读取 15,234 tokens (来自会话缓存)                   │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

### 场景变体

**场景 A：正常路由（无亲和性、无重试）**

```
│  ① MODEL RESOLUTION                                                │
│    gpt-4o ──→ gpt-4o                                               │
│                                                                     │
│  ② SESSION AFFINITY                                                │
│    (无会话标识)                                                     │
│                                                                     │
│  ③ UPSTREAM SELECTION                                              │
│    ● openai-primary  [closed]  w:10  ← 选中                       │
│    ○ openai-backup   [closed]  w:5                                  │
│                                                                     │
│  ④ EXECUTION & RETRIES                                             │
│    直接成功，无故障转移                                               │
│                                                                     │
│  ⑤ FINAL RESULT                                                    │
│    成功上游: openai-primary │ 总耗时: 1.23s                         │
```

**场景 B：亲和性命中（无迁移、无重试）**

```
│  ② SESSION AFFINITY                                                │
│    会话ID: 550e84...440000                                         │
│    状态: 🔗 命中绑定  →  rc                                        │
│    (无迁移条件)                                                     │
│                                                                     │
│  ④ EXECUTION & RETRIES                                             │
│    直接成功，无故障转移                                               │
```

**场景 C：亲和性绑定上游不可用，重新选择**

```
│  ② SESSION AFFINITY                                                │
│    会话ID: 550e84...440000                                         │
│    状态: ⚠️ 绑定上游不可用 (rc: 熔断开启)                           │
│    决策: 重新选择上游                                                │
```

### 视觉层级说明

| 元素 | 样式 | 用途 |
|------|------|------|
| 阶段编号 `①②③④⑤` | 大号字体 + 琥珀色 | 引导阅读顺序 |
| 阶段标题 | 大写等宽 + 琥珀色 | 快速识别区域 |
| 分隔线 `┄┄┄` | 虚线 + 暗色 | 分隔阶段 |
| 选中上游 `●` | 琥珀色高亮背景 | 突出最终选择 |
| 成功标记 `✓` | 绿色 | 成功状态 |
| 失败标记 `⚡` | 红色 | 失败/错误状态 |
| 迁移标记 `↗️` | 琥珀色 | 迁移动作 |
| 会话绑定 `🔗` | 绿色 | 亲和性绑定 |
| 时间戳 | 等宽字体，右对齐 | 精确时序 |

## Risks / Trade-offs

**[风险] 数据库迁移增加部署复杂度**
→ 缓解：新增字段均为 nullable，不影响现有数据；迁移脚本为纯添加字段，可安全回滚

**[风险] 时间线布局在移动端显示不佳**
→ 缓解：紧凑视图保持现有布局不变；展开视图在窄屏下使用水平滚动或折叠部分阶段

**[风险] 故障转移历史数据量大时影响性能**
→ 缓解：限制展示最多 5 次尝试，超出显示"...还有 N 次"；使用虚拟滚动（如需要）

**[风险] 会话 ID 暴露敏感信息**
→ 缓解：会话 ID 本身不敏感（UUID 格式），但避免在日志中展示完整的 user_id

**[权衡] 信息完整性与界面简洁性**
→ 决策：默认展开视图展示所有阶段，但允许用户点击阶段标题折叠；紧凑视图保持极简

## Migration Plan

**部署步骤：**
1. 生成数据库迁移（添加字段）
2. 部署后端代码（新字段写入）
3. 部署前端代码（时间线组件）
4. 验证：检查新请求是否展示亲和性信息

**回滚策略：**
- 后端回滚：新字段写入会停止，但已有数据保留（nullable 字段安全）
- 前端回滚：回退到旧版组件，新字段数据不展示但不影响功能

## Open Questions

1. 是否需要展示亲和性缓存的 TTL 剩余时间？（可能过于技术细节）
2. 重试详情是否需要在紧凑视图中显示摘要（如"3次尝试"）？
3. 是否需要将会话 ID 添加为可点击的筛选链接？（超出当前 scope，但需预留接口）
