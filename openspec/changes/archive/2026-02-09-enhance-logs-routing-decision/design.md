## Context

å½“å‰æ—¥å¿—ç³»ç»Ÿå·²ç»è®°å½•äº†åŸºæœ¬çš„è·¯ç”±ä¿¡æ¯ï¼ˆ`routing_type`, `group_name`, `lb_strategy`, `failover_attempts`, `failover_history`ï¼‰ï¼Œä½†ç¼ºå°‘å®Œæ•´çš„è·¯ç”±å†³ç­–è¿‡ç¨‹ä¿¡æ¯ã€‚

`ModelRouterResult` æ¥å£å·²ç»åŒ…å«äº†ä¸°å¯Œçš„å†³ç­–æ•°æ®ï¼š

- `candidateUpstreams`: å€™é€‰ä¸Šæ¸¸åˆ—è¡¨ï¼ˆid, name, weight, circuitState, allowedModelsï¼‰
- `excludedUpstreams`: è¢«æ’é™¤ä¸Šæ¸¸åˆ—è¡¨ï¼ˆid, name, reasonï¼‰
- `routingDecision`: å†³ç­–è¯¦æƒ…ï¼ˆoriginalModel, resolvedModel, modelRedirectApplied, circuitBreakerFilter ç­‰ï¼‰

è¿™äº›æ•°æ®åœ¨è·¯ç”±æ—¶å·²ç»è®¡ç®—å‡ºæ¥ï¼Œåªéœ€è¦ä¼ é€’åˆ°æ—¥å¿—è®°å½•å±‚å¹¶å­˜å‚¨ã€‚

## Goals / Non-Goals

**Goals:**

- è®°å½•å®Œæ•´çš„è·¯ç”±å†³ç­–ä¿¡æ¯åˆ°æ•°æ®åº“
- åœ¨å‰ç«¯å±•ç¤ºè¯¦ç»†çš„è·¯ç”±å†³ç­–è¿‡ç¨‹
- å¸®åŠ©ç”¨æˆ·ç†è§£"ä¸ºä»€ä¹ˆé€‰æ‹©äº†è¿™ä¸ªä¸Šæ¸¸"
- æ”¯æŒæ•…éšœæ’æŸ¥å’Œè·¯ç”±ç­–ç•¥ä¼˜åŒ–

**Non-Goals:**

- ä¸æ”¹å˜ç°æœ‰çš„è·¯ç”±é€»è¾‘
- ä¸å¢åŠ è·¯ç”±å»¶è¿Ÿï¼ˆå†³ç­–ä¿¡æ¯å·²åœ¨è·¯ç”±æ—¶è®¡ç®—ï¼‰
- ä¸ä¿®æ”¹ç°æœ‰çš„ `failover_history` ç»“æ„ï¼ˆä¿æŒå…¼å®¹ï¼‰

## Decisions

### Decision 1: æ•°æ®å­˜å‚¨æ–¹æ¡ˆ

**é€‰æ‹©**: æ–°å¢å•ç‹¬çš„ `routing_decision` TEXT å­—æ®µå­˜å‚¨ JSON

**å¤‡é€‰æ–¹æ¡ˆ**:

- A. æ‹†åˆ†ä¸ºå¤šä¸ªå­—æ®µï¼ˆcandidate_count, excluded_count ç­‰ï¼‰
- B. æ–°å¢å•ç‹¬çš„ `routing_decision` JSON å­—æ®µ
- C. æ‰©å±•ç°æœ‰çš„ `failover_history` å­—æ®µ

**é€‰æ‹© B çš„ç†ç”±**:

- ç»“æ„çµæ´»ï¼Œå¯ä»¥å­˜å‚¨å¤æ‚çš„åµŒå¥—æ•°æ®
- å•æ¬¡å†™å…¥ï¼Œä¸å¢åŠ æ•°æ®åº“æ“ä½œ
- å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰å­—æ®µ
- æŸ¥è¯¢æ—¶å¯ä»¥æŒ‰éœ€è§£æï¼Œä¸å½±å“åˆ—è¡¨æ€§èƒ½

### Decision 2: JSON æ•°æ®ç»“æ„

```typescript
interface RoutingDecisionLog {
  // æ¨¡å‹è§£æ
  original_model: string;
  resolved_model: string;
  model_redirect_applied: boolean;

  // è·¯ç”±å†³ç­–
  provider_type: string | null;
  routing_type: "provider_type" | "group" | "none";

  // å€™é€‰ä¸Šæ¸¸ï¼ˆç®€åŒ–ç‰ˆï¼Œåªè®°å½•å…³é”®ä¿¡æ¯ï¼‰
  candidates: Array<{
    id: string;
    name: string;
    weight: number;
    circuit_state: "closed" | "open" | "half_open";
  }>;

  // è¢«æ’é™¤çš„ä¸Šæ¸¸
  excluded: Array<{
    id: string;
    name: string;
    reason: "circuit_open" | "model_not_allowed" | "unhealthy";
  }>;

  // ç»Ÿè®¡ä¿¡æ¯
  candidate_count: number;
  final_candidate_count: number;

  // é€‰æ‹©ä¿¡æ¯
  selected_upstream_id: string | null;
  selection_strategy: string; // lb_strategy
}
```

**è®¾è®¡è€ƒé‡**:

- ä½¿ç”¨ snake_case ä¸ç°æœ‰ API é£æ ¼ä¿æŒä¸€è‡´
- ä¸å­˜å‚¨ `allowedModels` æ•°ç»„ï¼ˆå¤ªå¤§ï¼Œä¸”ä¸å¸¸ç”¨ï¼‰
- å€™é€‰ä¸Šæ¸¸åªå­˜å‚¨å‚ä¸æœ€ç»ˆé€‰æ‹©çš„ï¼ˆè¿‡æ»¤åçš„ï¼‰

### Decision 3: å‰ç«¯å±•ç¤ºæ–¹æ¡ˆ

**é€‰æ‹©**: Tooltip + å¯å±•å¼€è¯¦æƒ…è¡Œ

**å±•ç¤ºå±‚æ¬¡**:

1. **ç´§å‡‘æ˜¾ç¤º**ï¼ˆè¡¨æ ¼å•å…ƒæ ¼ï¼‰:

   ```
   ğŸ–¥ï¸ duck
   [è‡ªåŠ¨] openai Â· 3/5
   ```

   - ä¸Šæ¸¸åç§°
   - è·¯ç”±ç±»å‹å¾½ç«  + åˆ†ç»„å + å€™é€‰æ•°/æ€»æ•°

2. **Tooltip**ï¼ˆæ‚¬åœæ˜¾ç¤ºï¼‰:
   - æ¨¡å‹è§£æä¿¡æ¯
   - å€™é€‰ä¸Šæ¸¸åˆ—è¡¨ï¼ˆå¸¦æƒé‡å’ŒçŠ¶æ€ï¼‰
   - è¢«æ’é™¤ä¸Šæ¸¸åˆ—è¡¨ï¼ˆå¸¦åŸå› ï¼‰

3. **å±•å¼€è¯¦æƒ…**ï¼ˆç‚¹å‡»å±•å¼€ï¼Œå¤ç”¨ç°æœ‰æ•…éšœè½¬ç§»å±•å¼€é€»è¾‘ï¼‰:
   - å®Œæ•´çš„è·¯ç”±å†³ç­–æµç¨‹
   - æ•…éšœè½¬ç§»å†å²ï¼ˆå¦‚æœ‰ï¼‰

**å¤‡é€‰æ–¹æ¡ˆ**:

- A. åªç”¨ Tooltip
- B. åªç”¨å±•å¼€è¯¦æƒ…
- C. æ–°å¼€è¯¦æƒ…å¼¹çª—

**é€‰æ‹© Tooltip + å±•å¼€çš„ç†ç”±**:

- Tooltip æä¾›å¿«é€Ÿé¢„è§ˆï¼Œä¸æ‰“æ–­æµè§ˆæµç¨‹
- å±•å¼€è¯¦æƒ…æä¾›å®Œæ•´ä¿¡æ¯ï¼Œé€‚åˆæ·±å…¥åˆ†æ
- å¤ç”¨ç°æœ‰å±•å¼€é€»è¾‘ï¼Œå‡å°‘ä»£ç æ”¹åŠ¨

### Decision 4: è§†è§‰æŒ‡ç¤ºå™¨

åœ¨è¡¨æ ¼è¡Œä¸­æ·»åŠ å›¾æ ‡å¿«é€ŸæŒ‡ç¤ºç‰¹æ®Šæƒ…å†µï¼š

| æ¡ä»¶                         | å›¾æ ‡ | è¯´æ˜             |
| ---------------------------- | ---- | ---------------- |
| `model_redirect_applied`     | ğŸ”„   | å‘ç”Ÿäº†æ¨¡å‹é‡å®šå‘ |
| `failover_attempts > 0`      | âš¡   | å‘ç”Ÿäº†æ•…éšœè½¬ç§»   |
| `excluded.length > 0`        | ğŸ”’   | æœ‰ä¸Šæ¸¸è¢«æ’é™¤     |
| `final_candidate_count <= 1` | âš ï¸   | å€™é€‰ä¸Šæ¸¸ä¸è¶³     |

## Risks / Trade-offs

### Risk 1: æ•°æ®åº“å­˜å‚¨å¢åŠ 

- **é£é™©**: `routing_decision` JSON å¯èƒ½è¾ƒå¤§ï¼ˆçº¦ 500-2000 å­—èŠ‚/æ¡ï¼‰
- **ç¼“è§£**:
  - åªå­˜å‚¨å¿…è¦å­—æ®µï¼Œä¸å­˜å‚¨ `allowedModels` æ•°ç»„
  - æ—¥å¿—æœ‰ä¿ç•™æœŸé™ï¼Œå®šæœŸæ¸…ç†
  - å¯è€ƒè™‘å‹ç¼©å­˜å‚¨ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

### Risk 2: å‰ç«¯æ¸²æŸ“æ€§èƒ½

- **é£é™©**: å¤§é‡æ—¥å¿—æ—¶ Tooltip æ¸²æŸ“å¯èƒ½å½±å“æ€§èƒ½
- **ç¼“è§£**:
  - Tooltip å»¶è¿ŸåŠ è½½ï¼ˆæ‚¬åœ 300ms åæ˜¾ç¤ºï¼‰
  - JSON è§£æä½¿ç”¨ useMemo ç¼“å­˜
  - è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æœåˆ—è¡¨å¾ˆé•¿ï¼‰

### Risk 3: å‘åå…¼å®¹

- **é£é™©**: æ—§æ—¥å¿—æ²¡æœ‰ `routing_decision` å­—æ®µ
- **ç¼“è§£**:
  - å‰ç«¯ä¼˜é›…é™çº§ï¼Œå­—æ®µä¸ºç©ºæ—¶æ˜¾ç¤º "â€”" æˆ–éšè—è¯¦æƒ…
  - ä¸å½±å“ç°æœ‰åŠŸèƒ½

## Migration Plan

1. **Phase 1: åç«¯**
   - æ·»åŠ æ•°æ®åº“è¿ç§»ï¼ˆæ–°å¢ `routing_decision` å­—æ®µï¼‰
   - ä¿®æ”¹ `logRequest` / `logRequestStart` / `updateRequestLog` æ¥å£
   - ä¿®æ”¹ä»£ç†è·¯ç”±ä¼ é€’è·¯ç”±å†³ç­–ä¿¡æ¯
   - æ›´æ–° API ç±»å‹å®šä¹‰

2. **Phase 2: å‰ç«¯**
   - åˆ›å»º `RoutingDecisionDisplay` ç»„ä»¶
   - ä¿®æ”¹ `logs-table.tsx` é›†æˆæ–°ç»„ä»¶
   - æ·»åŠ å›½é™…åŒ–ç¿»è¯‘

3. **Phase 3: æµ‹è¯•**
   - å•å…ƒæµ‹è¯•ï¼šæ—¥å¿—è®°å½•ã€API å“åº”
   - ç»„ä»¶æµ‹è¯•ï¼šå±•ç¤ºç»„ä»¶
   - E2E æµ‹è¯•ï¼šå®Œæ•´æµç¨‹

**å›æ»šç­–ç•¥**:

- æ•°æ®åº“å­—æ®µä¸ºå¯é€‰ï¼Œå›æ»šæ—¶å‰ç«¯å¿½ç•¥å³å¯
- ä¸éœ€è¦åˆ é™¤æ•°æ®åº“å­—æ®µ
