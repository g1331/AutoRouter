## 1. 数据模型与接口契约

- [ ] 1.1 为 `upstreams` 数据模型新增 `routeCapabilities` 字段（PG/SQLite schema 与类型导出同步）
- [ ] 1.2 在上游创建与更新接口中接入 `routeCapabilities` 读写与参数校验
- [ ] 1.3 在 `src/types/api.ts` 补齐 `route_capabilities` 的请求/响应类型定义
- [ ] 1.4 实现旧字段到新能力集合的默认映射函数，并在迁移/启动流程中可幂等执行

## 2. 路径能力匹配与路由主流程

- [ ] 2.1 新建路径能力映射模块，支持方法+路径到能力类型的标准化匹配
- [ ] 2.2 在 `handleProxy` 中接入“路径优先、模型兜底”的决策入口
- [ ] 2.3 重构候选集构建逻辑为“能力过滤 → 授权过滤 → 健康过滤”
- [ ] 2.4 将过滤后候选接入现有优先级与故障转移流程，确保无回归
- [ ] 2.5 补充无候选场景的统一错误返回与用户提示

## 3. 会话亲和性适配

- [ ] 3.1 将会话提取逻辑从 `providerType` 维度改为 `routeCapability` 维度
- [ ] 3.2 将亲和性缓存键从 `apiKeyId+providerType+sessionId` 升级为 `apiKeyId+routeCapability+sessionId`
- [ ] 3.3 调整亲和性命中判定，禁止跨能力类型复用会话绑定
- [ ] 3.4 校验亲和性迁移与累计 token 统计在新键模型下保持正确

## 4. 管理端能力配置与展示

- [ ] 4.1 在上游创建/编辑表单新增能力多选组件并支持回显
- [ ] 4.2 在上游列表新增能力标签展示并保持移动端可读性
- [ ] 4.3 为能力配置补齐中英文文案与表单校验提示
- [ ] 4.4 保留兼容字段展示路径并标注迁移期说明

## 5. 路由日志与可观测性

- [ ] 5.1 扩展路由决策日志结构，新增 `matched_route_capability` 与 `route_match_source`
- [ ] 5.2 在请求日志写入链路中记录能力候选数量与兜底来源
- [ ] 5.3 在日志展示端补充能力命中信息展示位

## 6. 测试与发布保障

- [ ] 6.1 为路径能力匹配模块新增单元测试，覆盖 Claude/Codex/Gemini/OpenAI 常见路径
- [ ] 6.2 为代理路由新增单元与集成测试，覆盖路径命中、模型兜底、无候选错误
- [ ] 6.3 为上游多能力配置新增 CRUD 测试与参数校验测试
- [ ] 6.4 为会话亲和性新增回归测试，覆盖新键策略与跨能力隔离
- [ ] 6.5 完成 `pnpm lint`、`pnpm exec tsc --noEmit`、`pnpm test:run` 并修复阻断项
