## Context

AutoRouter 当前已经具备请求日志、故障转移、上游管理与统计展示能力，但缺少“计费真相层”：无法将每次请求的 token 用量映射为可追溯费用，也无法向用户解释“为什么这个上游更贵”。  
本次变更面向两类核心场景：

1. 个人开发者：希望快速看到今天/本月花费、不同上游成本差异、异常高价模型。
2. 小团队管理员：希望在共享网关下统一配置倍率与价格兜底，避免因渠道价格漂移导致成本不可控。

约束与前提：

- 不引入完整多租户模型，保持单管理员控制台路径不变。
- 与现有日志链路兼容，不能影响代理主路径的可用性与故障转移能力。
- 同时兼容 PostgreSQL / SQLite 双 schema。

## Goals / Non-Goals

**Goals:**

- 提供可落地的请求级费用计算与持久化快照能力（历史账单不随配置变动而漂移）
- 提供可维护的模型价格目录（自动同步 + 手动覆盖）
- 提供可直接操作的 Billing 管理页，覆盖“看总览、配倍率、修缺失、查明细”四条核心路径
- 保持现有 API 与页面行为向后兼容

**Non-Goals:**

- 不实现组织级多租户账单结算与发票流程
- 不接入第三方支付、订阅、充值系统
- 不做跨月财务报表导出（CSV/PDF）首版能力
- 不修改现有故障转移策略本身

## Decisions

### 决策 1：价格源采用 LiteLLM 单源策略

- 方案：使用 LiteLLM 价格映射作为自动同步来源；无法命中时由手动覆盖兜底；保留来源字段与同步时间。
- 原因：LiteLLM 对模型别名覆盖更广，更贴合聚合网关与 CLI 的模型命名习惯，能降低“有请求但未命中价格”的概率。
- 备选方案：
  - OpenRouter + LiteLLM 双源：维护复杂度更高，且仍可能出现模型命名不一致导致的误判。
  - 完全人工维护价格：可用但运营成本高，且更新延迟大。

### 决策 2：费用以“请求完成时快照”写入独立记录

- 方案：在请求日志完成阶段计算费用，并将基础单价、倍率、token 细节、最终费用固化存储。
- 原因：后续调价不影响历史账单，便于审计与回放。
- 备选方案：
  - 查询时实时回算：历史会随价格变化漂移，无法审计。

### 决策 3：倍率配置放在 upstream 维度

- 方案：每个 upstream 可配置输入/输出倍率（默认 1.0），请求结算时应用该倍率。
- 原因：贴合用户“不同渠道同模型不同成本”的真实使用模式。
- 备选方案：
  - 仅模型维度倍率：无法表达同模型在不同上游成本差异。

### 决策 4：前端信息架构按“运营动作”组织，而非按技术对象组织

- 方案：System/Billing 页面聚焦“价格与修复”：概览、价格目录、缺失修复，并提供进入请求日志查看请求费用的入口；上游倍率配置放在 `/upstreams` 上游管理页面。
- 原因：Billing 页面需要避免混入“渠道启停”等上游语义，减少误解；请求级费用追溯在请求日志中更自然且信息更全。

关键页面布局草图（桌面）：

```text
+--------------------------------------------------------------+
| Topbar: Billing                                              |
+--------------------------------------------------------------+
| [今日费用] [本月费用] [未定价模型] [价格同步状态]              |
+--------------------------+-----------------------------------+
+ 缺失价格修复                                                 |
+ model | 建议来源 | 手动录入按钮                               |
+ ...                                                        |
+--------------------------------------------------------------+
+ 模型价格目录（同步后的价格表）                               |
+ model | source | input | output | cache | synced_at | status |
+--------------------------------------------------------------+
+ 查看请求费用（跳转 /logs）                                   |
+--------------------------------------------------------------+
```

关键页面布局草图（移动端）：

```text
[卡片纵向堆叠]
今日费用
本月费用
未定价模型
同步状态

[折叠区块]
1) 缺失价格修复
2) 模型价格目录
3) 查看请求费用（跳转 /logs）
```

费用计算与展示数据流：

```text
Proxy Response
   -> extract token usage
   -> resolve model price (override > synced > unresolved)
   -> load upstream multiplier
   -> calculate final cost
   -> persist billing snapshot
   -> admin billing APIs aggregate
   -> Billing UI render cards/table
```

## Risks / Trade-offs

- [风险] 外部价格源不可用或结构变化  
  -> 缓解：保留上次有效快照、标记同步失败、允许手动覆盖。

- [风险] 部分请求缺少模型名或 token 统计，导致无法计费  
  -> 缓解：写入“未计费原因”状态并在修复区集中展示，不阻断主请求。

- [风险] 代理路径增加计费逻辑可能影响性能  
  -> 缓解：计算逻辑保持 O(1) 轻量运算，外部价格同步放在后台任务或管理端触发，不在请求内拉取远程数据。

- [风险] UI 信息过多导致理解成本上升  
  -> 缓解：首屏只展示四个关键卡片，复杂信息下沉到表格与弹窗。

## Migration Plan

1. 数据层迁移
   - 新增价格目录、手动覆盖、请求费用快照结构
   - 为 upstream 增加倍率字段（或独立配置表）
2. 后端服务接入
   - 增加价格同步服务、价格解析服务、费用计算服务
   - 在请求日志完成阶段写入费用快照
3. 管理 API 与前端页面
   - 新增 Billing API 与 React Query hooks
   - 新增 `/system/billing` 页面并加入系统导航入口
4. 验证与回滚
   - 新字段默认值保证向后兼容
   - 回滚可通过停用 billing 页面与 API，保留历史数据不删库

## Open Questions

- 首版“费用单位”是否统一用 USD 展示，还是允许用户切换展示币种（建议首版固定 USD）？
- 价格同步触发方式是“手动点击 + 定时任务”还是仅手动触发（建议首版支持手动，定时可后续追加）？
- 对“未计费请求”是否需要单独告警阈值（建议后续迭代）？
