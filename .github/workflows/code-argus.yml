name: Code-Argus Review

# ============================================================
# SECURITY MODEL:
# This workflow is designed following GitHub's workflow_run pattern
# to separate privileged and unprivileged operations.
#
# This file (code-argus.yml): Runs the actual code review
# - Triggered by: pull_request (auto), repository_dispatch (manual re-trigger)
# - Checkouts PR code at pinned SHA
# - Runs Codex review in read-only sandbox
# - Saves results to artifact (consumed by code-argus-publish.yml)
#
# Related workflows:
# - code-argus-comment.yml: Handles issue_comment, dispatches here
# - code-argus-publish.yml: Handles workflow_run, posts comments
# ============================================================

on:
  pull_request:
    types: [opened, reopened]
  repository_dispatch:
    types: [code-argus-review]

env:
  CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
  CODEX_BASE_URL: ${{ secrets.CODEX_BASE_URL }}
  CODEX_MODEL: ${{ vars.CODEX_MODEL }}

concurrency:
  group: code-argus-${{ github.event.pull_request.number || github.event.client_payload.pr_number || github.run_id }}
  cancel-in-progress: true

# Minimal permissions - only read access
permissions:
  contents: read

jobs:
  review:
    name: Review
    runs-on: ubuntu-latest
    # Skip bot-triggered events (GitHub Actions bot, Dependabot, etc.)
    if: |
      github.actor != 'github-actions[bot]' &&
      github.actor != 'dependabot[bot]'
    timeout-minutes: 45

    steps:
      # ============================================================
      # Step 1: Determine PR context
      # ============================================================
      - name: Set PR context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, headSha, baseRef;

            if (context.eventName === 'pull_request') {
              // Direct PR event - use event payload directly (CodeQL approved)
              prNumber = context.payload.pull_request.number;
              headSha = context.payload.pull_request.head.sha;
              baseRef = context.payload.pull_request.base.ref;
            } else if (context.eventName === 'repository_dispatch') {
              // Triggered by comment workflow
              prNumber = context.payload.client_payload.pr_number;
              headSha = context.payload.client_payload.head_sha;
              baseRef = context.payload.client_payload.base_ref;
            }

            if (!prNumber || !headSha || !baseRef) {
              core.setFailed('Missing PR context');
              return;
            }

            core.setOutput('pr_number', prNumber.toString());
            core.setOutput('head_sha', headSha);
            core.setOutput('base_ref', baseRef);

            console.log(`PR #${prNumber}, SHA: ${headSha}, Base: ${baseRef}`);

      # ============================================================
      # Step 2: Checkout PR code at pinned SHA
      # ============================================================
      - name: Checkout PR at pinned SHA
        uses: actions/checkout@v4
        with:
          # Use immutable SHA reference to prevent TOCTOU attacks
          ref: ${{ steps.context.outputs.head_sha }}
          fetch-depth: 0

      - name: Fetch base branch for diff
        run: git fetch --no-tags origin ${{ steps.context.outputs.base_ref }}

      # ============================================================
      # Step 3: Prepare review input
      # ============================================================
      - name: Load config
        id: config
        run: |
          # Use defaults - don't load config from potentially untrusted PR code
          MAX_COMMENTS=10
          MIN_SEVERITY=low
          LANGUAGE=auto
          MODEL="${CODEX_MODEL:-gpt-5.2}"

          echo "max_comments=$MAX_COMMENTS" >> $GITHUB_OUTPUT
          echo "min_severity=$MIN_SEVERITY" >> $GITHUB_OUTPUT
          echo "language=$LANGUAGE" >> $GITHUB_OUTPUT
          echo "model=$MODEL" >> $GITHUB_OUTPUT

      - name: Fetch PR title/body
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.context.outputs.pr_number }}
        with:
          script: |
            const fs = require('fs');
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            if (!prNumber || Number.isNaN(prNumber)) {
              fs.writeFileSync('/tmp/pr_title.txt', '', 'utf8');
              fs.writeFileSync('/tmp/pr_body.txt', '', 'utf8');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            fs.writeFileSync('/tmp/pr_title.txt', pr.title || '', 'utf8');
            fs.writeFileSync('/tmp/pr_body.txt', pr.body || '', 'utf8');

      - name: Prepare prompt file
        run: |
          mkdir -p .github/codex/prompts

          # Generate diff (HEAD is the pinned PR SHA)
          git diff origin/${{ steps.context.outputs.base_ref }}...HEAD > /tmp/pr_diff.txt

          # Generate prompt file
          cat > .github/codex/prompts/review.md << 'PROMPT_EOF'
          # Code-Argus Review Instructions

          You are Code-Argus, an expert code reviewer focused on high-impact issues.

          ## Core Principles

          1. **High signal-to-noise**: Only comment if it would likely change a merge decision
          2. **No style nits**: Never comment on formatting, naming conventions, or subjective preferences
          3. **Actionable feedback**: Every comment must include a concrete fix

          ## Review Focus Areas

          - **Correctness**: Logic errors, edge cases, null handling, race conditions
          - **Security**: XSS, injection, auth bypass, sensitive data exposure
          - **Architecture**: Breaking changes, API compatibility, cross-system impact
          - **Testing**: Missing tests for critical paths, inadequate coverage

          Do NOT comment on:
          - Code style, formatting, or naming conventions
          - Minor optimizations that don't affect functionality
          - Personal preferences or "nice to have" suggestions

          ## Configuration

          PROMPT_EOF

          echo "- Maximum comments: ${{ steps.config.outputs.max_comments }}" >> .github/codex/prompts/review.md
          echo "- Minimum severity: ${{ steps.config.outputs.min_severity }}" >> .github/codex/prompts/review.md
          echo "- Language: ${{ steps.config.outputs.language }} (if 'auto', use the same language as the PR)" >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md

          cat >> .github/codex/prompts/review.md << 'PROMPT_EOF'
          ## Output Format

          Return a JSON object with this exact structure:

          ```json
          {
            "summary": {
              "total_issues": 0,
              "high": 0,
              "medium": 0,
              "low": 0,
              "focus_areas": [],
              "pr_summary": "One-sentence summary of what this PR does",
              "changes": [
                "First major change or feature added",
                "Second major change or feature added"
              ],
              "technical_notes": "Optional technical notes about implementation details, trade-offs, or important considerations (can be empty string if none)"
            },
            "comments": []
          }
          ```

          ### Summary Fields (REQUIRED)
          - `pr_summary`: A concise one-sentence summary of the PR's purpose and impact
          - `changes`: Array of 2-6 bullet points describing the main changes (use imperative mood: "Add...", "Update...", "Fix...")
          - `technical_notes`: Any important technical details reviewers should know (leave empty string if none)

          Each comment in the array should have:
          - `file`: path to the file (e.g., "src/api/routes.ts")
          - `line_start`: starting line number
          - `line_end`: ending line number (same as line_start if single line)
          - `severity`: "high", "medium", or "low"
          - `title`: brief issue title
          - `description`: why this is a problem
          - `suggestion`: the fixed code (will be shown as GitHub suggested change)

          ### CRITICAL: GitHub API Constraints for Inline Comments

          GitHub only allows review comments on lines that are **actually part of the PR diff**. Your comments will FAIL if they violate these rules:

          1. **`file` MUST be a file that appears in the PR diff** (listed in "## PR Diff" section below)
             - Files not modified by this PR cannot receive comments
             - Example: If `.env.example` is not in the diff, you CANNOT comment on it

          2. **`line_start` and `line_end` MUST point to lines with `+` prefix in the diff**
             - These are the NEW/MODIFIED lines in the PR
             - Lines with `-` prefix (deleted lines) or unchanged context lines CANNOT receive comments
             - The line number should be the actual line number in the NEW version of the file

          3. **`suggestion` MUST be valid replacement code for the exact lines specified**
             - It replaces the content from `line_start` to `line_end`
             - Must maintain proper indentation matching the original code

          **If you find an issue in code NOT in the diff:**
          - Do NOT create a comment for it
          - Instead, mention it in `summary.technical_notes` field
          - Example: "Note: Related code in `config.py:45` may also need updating but is outside this PR's scope"

          ## Instructions

          1. You MAY read any file in the repository and run searches to understand context
          2. Review ONLY the changes in this PR (diff provided below); comments MUST target lines within the diff
          3. Sort issues by severity (high first), then limit to max_comments
          4. If language is 'auto', respond in the same language as the PR title/description
          5. If no significant issues found, return empty comments array
          6. Output ONLY the JSON object, no other text
          7. VERIFY each comment's file and line are in the diff before including it

          ## PR Information

          PROMPT_EOF

          echo -n "**Title**: " >> .github/codex/prompts/review.md
          cat /tmp/pr_title.txt >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo "**Description**:" >> .github/codex/prompts/review.md
          cat /tmp/pr_body.txt >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo "## PR Diff" >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo '```diff' >> .github/codex/prompts/review.md
          cat /tmp/pr_diff.txt >> .github/codex/prompts/review.md
          echo '```' >> .github/codex/prompts/review.md

      # ============================================================
      # Step 4: Run Code-Argus Review
      # ============================================================
      - name: Run Code-Argus
        id: review
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.CODEX_API_KEY }}
          responses-api-endpoint: ${{ secrets.CODEX_BASE_URL }}/responses
          model: ${{ steps.config.outputs.model }}
          effort: xhigh
          sandbox: read-only
          prompt-file: .github/codex/prompts/review.md
          output-schema: |
            {
              "type": "object",
              "properties": {
                "summary": {
                  "type": "object",
                  "properties": {
                    "total_issues": { "type": "integer" },
                    "high": { "type": "integer" },
                    "medium": { "type": "integer" },
                    "low": { "type": "integer" },
                    "focus_areas": { "type": "array", "items": { "type": "string" } },
                    "pr_summary": { "type": "string" },
                    "changes": { "type": "array", "items": { "type": "string" } },
                    "technical_notes": { "type": "string" }
                  },
                  "required": ["total_issues", "high", "medium", "low", "focus_areas", "pr_summary", "changes", "technical_notes"],
                  "additionalProperties": false
                },
                "comments": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "file": { "type": "string" },
                      "line_start": { "type": "integer" },
                      "line_end": { "type": "integer" },
                      "severity": { "type": "string", "enum": ["high", "medium", "low"] },
                      "title": { "type": "string" },
                      "description": { "type": "string" },
                      "suggestion": { "type": "string" }
                    },
                    "required": ["file", "line_start", "line_end", "severity", "title", "description", "suggestion"],
                    "additionalProperties": false
                  }
                }
              },
              "required": ["summary", "comments"],
              "additionalProperties": false
            }

      # ============================================================
      # Step 5: Save results as artifact for publish workflow
      # ============================================================
      - name: Save review results
        run: |
          mkdir -p /tmp/review-results
          echo '${{ steps.context.outputs.pr_number }}' > /tmp/review-results/pr_number.txt
          echo '${{ steps.context.outputs.head_sha }}' > /tmp/review-results/head_sha.txt
          echo '${{ steps.review.outputs.final-message }}' > /tmp/review-results/review_output.json

      - name: Upload review artifact
        uses: actions/upload-artifact@v4
        with:
          name: code-argus-review-${{ steps.context.outputs.pr_number }}
          path: /tmp/review-results/
          retention-days: 1
