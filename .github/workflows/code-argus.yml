name: Code-Argus Review

on:
  pull_request:
    types: [opened, reopened]
  issue_comment:
    types: [created]

env:
  CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
  CODEX_BASE_URL: ${{ vars.CODEX_BASE_URL }}

jobs:
  review:
    runs-on: ubuntu-latest
    # PR Ëá™Âä®Ëß¶Âèë Êàñ PR ËØÑËÆ∫‰∏≠ÂåÖÂê´Ëß¶ÂèëÂÖ≥ÈîÆËØç
    if: |
      github.event_name == 'pull_request' ||
      (github.event.issue.pull_request &&
       (contains(github.event.comment.body, 'code-argus review') ||
        contains(github.event.comment.body, 'argus review') ||
        contains(github.event.comment.body, 'code-argus ÂÆ°Êü•')))

    permissions:
      contents: read
      pull-requests: write

    steps:
      # ============================================================
      # Step 1: ÊùÉÈôêÊ£ÄÊü• - ‰ªÖ collaborators ÂèØËß¶Âèë
      # ============================================================
      - name: Check permissions
        id: check_perm
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.actor
              });
              const allowed = ['admin', 'write'].includes(data.permission);
              core.setOutput('allowed', allowed);
              if (!allowed) {
                console.log(`User ${context.actor} has ${data.permission} permission, skipping review`);
              }
              return allowed;
            } catch (error) {
              console.log(`Permission check failed: ${error.message}`);
              core.setOutput('allowed', false);
              return false;
            }

      # ============================================================
      # Step 2: Checkout PR ‰ª£Á†Å
      # ============================================================
      - name: Checkout
        if: steps.check_perm.outputs.allowed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR number
        if: steps.check_perm.outputs.allowed == 'true'
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "base=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            BASE=$(gh pr view ${{ github.event.issue.number }} --json baseRefName --jq '.baseRefName')
            echo "base=$BASE" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch PR refs
        if: steps.check_perm.outputs.allowed == 'true'
        run: |
          git fetch --no-tags origin ${{ steps.pr.outputs.base }}
          git fetch --no-tags origin +refs/pull/${{ steps.pr.outputs.number }}/head:refs/remotes/origin/pr-head

      # ============================================================
      # Step 3: ÂáÜÂ§á Review ËæìÂÖ•
      # ============================================================
      - name: Load config
        if: steps.check_perm.outputs.allowed == 'true'
        id: config
        run: |
          MAX_COMMENTS=10
          MIN_SEVERITY=low
          LANGUAGE=auto

          if [ -f ".github/reviewbot.yaml" ]; then
            if command -v yq &> /dev/null; then
              MAX_COMMENTS=$(yq '.max_comments // 10' .github/reviewbot.yaml)
              MIN_SEVERITY=$(yq '.min_severity // "low"' .github/reviewbot.yaml)
              LANGUAGE=$(yq '.language // "auto"' .github/reviewbot.yaml)
            fi
          fi

          echo "max_comments=$MAX_COMMENTS" >> $GITHUB_OUTPUT
          echo "min_severity=$MIN_SEVERITY" >> $GITHUB_OUTPUT
          echo "language=$LANGUAGE" >> $GITHUB_OUTPUT

      - name: Prepare prompt file
        if: steps.check_perm.outputs.allowed == 'true'
        run: |
          mkdir -p .github/codex/prompts

          # Ëé∑Âèñ diff Âπ∂‰øùÂ≠òÂà∞‰∏¥Êó∂Êñá‰ª∂ÔºàÈÅøÂÖç shell ÂèòÈáèÈïøÂ∫¶ÈôêÂà∂Ôºâ
          git diff origin/${{ steps.pr.outputs.base }}...origin/pr-head > /tmp/pr_diff.txt

          # Ëé∑Âèñ PR ‰ø°ÊÅØ
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            gh pr view ${{ github.event.pull_request.number }} --json title,body \
              --jq '.title' > /tmp/pr_title.txt
            gh pr view ${{ github.event.pull_request.number }} --json title,body \
              --jq '.body // ""' > /tmp/pr_body.txt
          else
            gh pr view ${{ steps.pr.outputs.number }} --json title,body \
              --jq '.title' > /tmp/pr_title.txt
            gh pr view ${{ steps.pr.outputs.number }} --json title,body \
              --jq '.body // ""' > /tmp/pr_body.txt
          fi

          # ÁîüÊàê prompt Êñá‰ª∂
          cat > .github/codex/prompts/review.md << 'PROMPT_EOF'
          # Code-Argus Review Instructions

          You are Code-Argus, an expert code reviewer focused on high-impact issues.

          ## Core Principles

          1. **High signal-to-noise**: Only comment if it would likely change a merge decision
          2. **No style nits**: Never comment on formatting, naming conventions, or subjective preferences
          3. **Actionable feedback**: Every comment must include a concrete fix

          ## Review Focus Areas

          - **Correctness**: Logic errors, edge cases, null handling, race conditions
          - **Security**: XSS, injection, auth bypass, sensitive data exposure
          - **Architecture**: Breaking changes, API compatibility, cross-system impact
          - **Testing**: Missing tests for critical paths, inadequate coverage

          Do NOT comment on:
          - Code style, formatting, or naming conventions
          - Minor optimizations that don't affect functionality
          - Personal preferences or "nice to have" suggestions

          ## Configuration

          PROMPT_EOF

          echo "- Maximum comments: ${{ steps.config.outputs.max_comments }}" >> .github/codex/prompts/review.md
          echo "- Minimum severity: ${{ steps.config.outputs.min_severity }}" >> .github/codex/prompts/review.md
          echo "- Language: ${{ steps.config.outputs.language }} (if 'auto', use the same language as the PR)" >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md

          cat >> .github/codex/prompts/review.md << 'PROMPT_EOF'
          ## Output Format

          Return a JSON object with this exact structure:

          ```json
          {
            "summary": {
              "total_issues": 0,
              "high": 0,
              "medium": 0,
              "low": 0,
              "focus_areas": []
            },
            "comments": []
          }
          ```

          Each comment in the array should have:
          - `file`: path to the file (e.g., "src/api/routes.ts")
          - `line_start`: starting line number
          - `line_end`: ending line number (same as line_start if single line)
          - `severity`: "high", "medium", or "low"
          - `title`: brief issue title
          - `description`: why this is a problem
          - `suggestion`: the fixed code (will be shown as GitHub suggested change)

          ## Instructions

          1. Review ONLY the changes in this PR (diff provided below)
          2. Sort issues by severity (high first), then limit to max_comments
          3. If language is 'auto', respond in the same language as the PR title/description
          4. If no significant issues found, return empty comments array
          5. Output ONLY the JSON object, no other text

          ## PR Information

          PROMPT_EOF

          echo -n "**Title**: " >> .github/codex/prompts/review.md
          cat /tmp/pr_title.txt >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo "**Description**:" >> .github/codex/prompts/review.md
          cat /tmp/pr_body.txt >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo "## PR Diff" >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo '```diff' >> .github/codex/prompts/review.md
          cat /tmp/pr_diff.txt >> .github/codex/prompts/review.md
          echo '```' >> .github/codex/prompts/review.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================
      # Step 4: ËøêË°å Code-Argus Review
      # ============================================================
      - name: Run Code-Argus
        if: steps.check_perm.outputs.allowed == 'true'
        id: review
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.CODEX_API_KEY }}
          responses-api-endpoint: ${{ vars.CODEX_BASE_URL }}
          prompt-file: .github/codex/prompts/review.md
          sandbox: read-only
          output-schema: |
            {
              "type": "object",
              "properties": {
                "summary": {
                  "type": "object",
                  "properties": {
                    "total_issues": { "type": "integer" },
                    "high": { "type": "integer" },
                    "medium": { "type": "integer" },
                    "low": { "type": "integer" },
                    "focus_areas": { "type": "array", "items": { "type": "string" } }
                  },
                  "required": ["total_issues", "high", "medium", "low", "focus_areas"]
                },
                "comments": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "file": { "type": "string" },
                      "line_start": { "type": "integer" },
                      "line_end": { "type": "integer" },
                      "severity": { "type": "string", "enum": ["high", "medium", "low"] },
                      "title": { "type": "string" },
                      "description": { "type": "string" },
                      "suggestion": { "type": "string" }
                    },
                    "required": ["file", "line_start", "line_end", "severity", "title", "description", "suggestion"]
                  }
                }
              },
              "required": ["summary", "comments"]
            }

      # ============================================================
      # Step 5: Ëß£ÊûêÂπ∂ÂèëÂ∏ÉËØÑËÆ∫
      # ============================================================
      - name: Post review comments
        if: steps.check_perm.outputs.allowed == 'true'
        uses: actions/github-script@v7
        env:
          REVIEW_OUTPUT: ${{ steps.review.outputs.final-message }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const output = process.env.REVIEW_OUTPUT || '';

            let review;
            const prNumber = parseInt(process.env.PR_NUMBER, 10);

            try {
              const jsonMatch = output.match(/```json\s*([\s\S]*?)\s*```/) ||
                               output.match(/\{[\s\S]*"summary"[\s\S]*\}/);
              const jsonStr = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : output;
              review = JSON.parse(jsonStr);
            } catch (e) {
              console.log('Failed to parse JSON output:', e.message);
              console.log('Raw output:', output);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## Code-Argus Review\n\n${output}`
              });
              return;
            }
            const severityEmoji = { high: 'üî¥', medium: 'üü°', low: 'üü¢' };

            // ÂèëÂ∏ÉË°åÂÜÖËØÑËÆ∫
            if (review.comments && review.comments.length > 0) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              const commitSha = pr.head.sha;

              for (const comment of review.comments) {
                const emoji = severityEmoji[comment.severity] || 'üü°';
                let body = `## ${emoji} [${comment.severity.toUpperCase()}] ${comment.title}\n\n`;
                body += `${comment.description}\n\n`;

                if (comment.suggestion) {
                  body += '```suggestion\n';
                  body += comment.suggestion;
                  if (!comment.suggestion.endsWith('\n')) body += '\n';
                  body += '```\n';
                }

                try {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    commit_id: commitSha,
                    path: comment.file,
                    line: comment.line_end || comment.line_start,
                    start_line: comment.line_start !== comment.line_end ? comment.line_start : undefined,
                    body: body
                  });
                } catch (e) {
                  console.log(`Failed to post comment on ${comment.file}:${comment.line_start}: ${e.message}`);
                }
              }
            }

            // ÂèëÂ∏ÉÊÄªÁªìËØÑËÆ∫
            const summary = review.summary || { total_issues: 0, high: 0, medium: 0, low: 0, focus_areas: [] };
            let summaryBody = `## Code-Argus Review\n\n`;

            if (summary.total_issues === 0) {
              summaryBody += `Review completed. **No significant issues found.**\n\n`;
              summaryBody += `The changes look good from a correctness, security, and architecture perspective.\n`;
            } else {
              summaryBody += `Review completed. **${summary.total_issues}** suggestion(s) posted.\n\n`;
              summaryBody += `| Severity | Count |\n`;
              summaryBody += `|----------|-------|\n`;
              if (summary.high > 0) summaryBody += `| üî¥ High | ${summary.high} |\n`;
              if (summary.medium > 0) summaryBody += `| üü° Medium | ${summary.medium} |\n`;
              if (summary.low > 0) summaryBody += `| üü¢ Low | ${summary.low} |\n`;

              if (summary.focus_areas && summary.focus_areas.length > 0) {
                summaryBody += `\n**Focus areas**: ${summary.focus_areas.join(', ')}\n`;
              }
            }

            summaryBody += `\n---\n`;
            summaryBody += `Comment \`code-argus review\` to re-trigger review`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: summaryBody
            });

      # ============================================================
      # Step 6: ÈîôËØØÂ§ÑÁêÜ
      # ============================================================
      - name: Handle failure
        if: failure() && steps.check_perm.outputs.allowed == 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            if (!prNumber || isNaN(prNumber)) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## Code-Argus Review\n\n‚ùå Review failed. Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\nComment \`code-argus review\` to retry.`
            });
