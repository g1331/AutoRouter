name: Code-Argus Review

on:
  pull_request:
    types: [opened, reopened]
  issue_comment:
    types: [created]

env:
  CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
  CODEX_BASE_URL: ${{ secrets.CODEX_BASE_URL }}

jobs:
  review:
    runs-on: ubuntu-latest
    # PR Ëá™Âä®Ëß¶Âèë Êàñ PR ËØÑËÆ∫‰∏≠ÂåÖÂê´Ëß¶ÂèëÂÖ≥ÈîÆËØç
    if: |
      github.event_name == 'pull_request' ||
      (github.event.issue.pull_request &&
       (contains(github.event.comment.body, 'code-argus review') ||
        contains(github.event.comment.body, 'argus review') ||
        contains(github.event.comment.body, 'code-argus ÂÆ°Êü•')))

    permissions:
      contents: read
      pull-requests: write

    steps:
      # ============================================================
      # Step 1: ÊùÉÈôêÊ£ÄÊü• - ‰ªÖ collaborators ÂèØËß¶Âèë
      # ============================================================
      - name: Check permissions
        id: check_perm
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.actor
              });
              const allowed = ['admin', 'write'].includes(data.permission);
              core.setOutput('allowed', allowed);
              if (!allowed) {
                console.log(`User ${context.actor} has ${data.permission} permission, skipping review`);
              }
              return allowed;
            } catch (error) {
              console.log(`Permission check failed: ${error.message}`);
              core.setOutput('allowed', false);
              return false;
            }

      # ============================================================
      # Step 2: Checkout PR ‰ª£Á†Å
      # ============================================================
      - name: Checkout
        if: steps.check_perm.outputs.allowed == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR number
        if: steps.check_perm.outputs.allowed == 'true'
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "base=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            BASE=$(gh pr view ${{ github.event.issue.number }} --json baseRefName --jq '.baseRefName')
            echo "base=$BASE" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch PR refs
        if: steps.check_perm.outputs.allowed == 'true'
        run: |
          git fetch --no-tags origin ${{ steps.pr.outputs.base }}
          git fetch --no-tags origin +refs/pull/${{ steps.pr.outputs.number }}/head:refs/remotes/origin/pr-head

      # ============================================================
      # Step 3: ÂáÜÂ§á Review ËæìÂÖ•
      # ============================================================
      - name: Load config
        if: steps.check_perm.outputs.allowed == 'true'
        id: config
        run: |
          MAX_COMMENTS=10
          MIN_SEVERITY=low
          LANGUAGE=auto

          if [ -f ".github/reviewbot.yaml" ]; then
            if command -v yq &> /dev/null; then
              MAX_COMMENTS=$(yq '.max_comments // 10' .github/reviewbot.yaml)
              MIN_SEVERITY=$(yq '.min_severity // "low"' .github/reviewbot.yaml)
              LANGUAGE=$(yq '.language // "auto"' .github/reviewbot.yaml)
            fi
          fi

          echo "max_comments=$MAX_COMMENTS" >> $GITHUB_OUTPUT
          echo "min_severity=$MIN_SEVERITY" >> $GITHUB_OUTPUT
          echo "language=$LANGUAGE" >> $GITHUB_OUTPUT

      - name: Prepare prompt file
        if: steps.check_perm.outputs.allowed == 'true'
        run: |
          mkdir -p .github/codex/prompts

          # Ëé∑Âèñ diff Âπ∂‰øùÂ≠òÂà∞‰∏¥Êó∂Êñá‰ª∂ÔºàÈÅøÂÖç shell ÂèòÈáèÈïøÂ∫¶ÈôêÂà∂Ôºâ
          git diff origin/${{ steps.pr.outputs.base }}...origin/pr-head > /tmp/pr_diff.txt

          # Ëé∑Âèñ PR ‰ø°ÊÅØ
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            gh pr view ${{ github.event.pull_request.number }} --json title,body \
              --jq '.title' > /tmp/pr_title.txt
            gh pr view ${{ github.event.pull_request.number }} --json title,body \
              --jq '.body // ""' > /tmp/pr_body.txt
          else
            gh pr view ${{ steps.pr.outputs.number }} --json title,body \
              --jq '.title' > /tmp/pr_title.txt
            gh pr view ${{ steps.pr.outputs.number }} --json title,body \
              --jq '.body // ""' > /tmp/pr_body.txt
          fi

          # ÁîüÊàê prompt Êñá‰ª∂
          cat > .github/codex/prompts/review.md << 'PROMPT_EOF'
          # Code-Argus Review Instructions

          You are Code-Argus, an expert code reviewer focused on high-impact issues.

          ## Core Principles

          1. **High signal-to-noise**: Only comment if it would likely change a merge decision
          2. **No style nits**: Never comment on formatting, naming conventions, or subjective preferences
          3. **Actionable feedback**: Every comment must include a concrete fix

          ## Review Focus Areas

          - **Correctness**: Logic errors, edge cases, null handling, race conditions
          - **Security**: XSS, injection, auth bypass, sensitive data exposure
          - **Architecture**: Breaking changes, API compatibility, cross-system impact
          - **Testing**: Missing tests for critical paths, inadequate coverage

          Do NOT comment on:
          - Code style, formatting, or naming conventions
          - Minor optimizations that don't affect functionality
          - Personal preferences or "nice to have" suggestions

          ## Configuration

          PROMPT_EOF

          echo "- Maximum comments: ${{ steps.config.outputs.max_comments }}" >> .github/codex/prompts/review.md
          echo "- Minimum severity: ${{ steps.config.outputs.min_severity }}" >> .github/codex/prompts/review.md
          echo "- Language: ${{ steps.config.outputs.language }} (if 'auto', use the same language as the PR)" >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md

          cat >> .github/codex/prompts/review.md << 'PROMPT_EOF'
          ## Output Format

          Return a JSON object with this exact structure:

          ```json
          {
            "summary": {
              "total_issues": 0,
              "high": 0,
              "medium": 0,
              "low": 0,
              "focus_areas": []
            },
            "comments": []
          }
          ```

          Each comment in the array should have:
          - `file`: path to the file (e.g., "src/api/routes.ts")
          - `line_start`: starting line number
          - `line_end`: ending line number (same as line_start if single line)
          - `severity`: "high", "medium", or "low"
          - `title`: brief issue title
          - `description`: why this is a problem
          - `suggestion`: the fixed code (will be shown as GitHub suggested change)

          ## Instructions

          1. Review ONLY the changes in this PR (diff provided below)
          2. Sort issues by severity (high first), then limit to max_comments
          3. If language is 'auto', respond in the same language as the PR title/description
          4. If no significant issues found, return empty comments array
          5. Output ONLY the JSON object, no other text

          ## PR Information

          PROMPT_EOF

          echo -n "**Title**: " >> .github/codex/prompts/review.md
          cat /tmp/pr_title.txt >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo "**Description**:" >> .github/codex/prompts/review.md
          cat /tmp/pr_body.txt >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo "## PR Diff" >> .github/codex/prompts/review.md
          echo "" >> .github/codex/prompts/review.md
          echo '```diff' >> .github/codex/prompts/review.md
          cat /tmp/pr_diff.txt >> .github/codex/prompts/review.md
          echo '```' >> .github/codex/prompts/review.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================
      # Step 4: ÈÖçÁΩÆ Codex CLI
      # ============================================================
      - name: Configure Codex
        if: steps.check_perm.outputs.allowed == 'true'
        run: |
          # ‰ΩøÁî®Áã¨Á´ãÁõÆÂΩïÈÅøÂÖç action Ë¶ÜÁõñÈÖçÁΩÆ
          CODEX_HOME_DIR="/tmp/codex-argus-home"
          mkdir -p "$CODEX_HOME_DIR"

          # ÂàõÂª∫ config.toml
          cat > "$CODEX_HOME_DIR/config.toml" << TOML
          model = "gpt-5.2"
          model_provider = "codex-api"
          model_reasoning_effort = "xhigh"
          disable_response_storage = true

          [model_providers.codex-api]
          name = "codex-api"
          base_url = "${CODEX_BASE_URL}"
          wire_api = "responses"
          requires_openai_auth = true
          TOML

          # ÂàõÂª∫ auth.json
          cat > "$CODEX_HOME_DIR/auth.json" << JSON
          {
            "OPENAI_API_KEY": "${CODEX_API_KEY}"
          }
          JSON

          echo "CODEX_HOME_DIR=$CODEX_HOME_DIR" >> $GITHUB_ENV

          echo "Codex config:"
          cat "$CODEX_HOME_DIR/config.toml"
        env:
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
          CODEX_BASE_URL: ${{ secrets.CODEX_BASE_URL }}

      # ============================================================
      # Step 5: ÂÆâË£Ö Codex CLI
      # ============================================================
      - name: Setup Node.js
        if: steps.check_perm.outputs.allowed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Codex CLI
        if: steps.check_perm.outputs.allowed == 'true'
        run: npm install -g @openai/codex

      # ============================================================
      # Step 6: ËøêË°å Code-Argus Review
      # ============================================================
      - name: Run Code-Argus
        if: steps.check_perm.outputs.allowed == 'true'
        id: review
        run: |
          # ÂàõÂª∫ output schema Êñá‰ª∂
          cat > /tmp/output-schema.json << 'SCHEMA_EOF'
          {
            "type": "object",
            "properties": {
              "summary": {
                "type": "object",
                "properties": {
                  "total_issues": { "type": "integer" },
                  "high": { "type": "integer" },
                  "medium": { "type": "integer" },
                  "low": { "type": "integer" },
                  "focus_areas": { "type": "array", "items": { "type": "string" } }
                },
                "required": ["total_issues", "high", "medium", "low", "focus_areas"],
                "additionalProperties": false
              },
              "comments": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "file": { "type": "string" },
                    "line_start": { "type": "integer" },
                    "line_end": { "type": "integer" },
                    "severity": { "type": "string", "enum": ["high", "medium", "low"] },
                    "title": { "type": "string" },
                    "description": { "type": "string" },
                    "suggestion": { "type": "string" }
                  },
                  "required": ["file", "line_start", "line_end", "severity", "title", "description", "suggestion"],
                  "additionalProperties": false
                }
              }
            },
            "required": ["summary", "comments"],
            "additionalProperties": false
          }
          SCHEMA_EOF

          # ËØªÂèñ prompt Êñá‰ª∂ÂÜÖÂÆπ
          PROMPT_CONTENT=$(cat .github/codex/prompts/review.md)

          # ËøêË°å codex execÔºàprompt ‰Ωú‰∏∫‰ΩçÁΩÆÂèÇÊï∞Ôºâ
          CODEX_HOME="$CODEX_HOME_DIR" codex exec \
            --output-schema /tmp/output-schema.json \
            --sandbox read-only \
            "$PROMPT_CONTENT" \
            > /tmp/review_output.txt 2>&1 || true

          # ËæìÂá∫ÁªìÊûú
          cat /tmp/review_output.txt

          # ËÆæÁΩÆ output
          {
            echo 'final-message<<EOF'
            cat /tmp/review_output.txt
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      # ============================================================
      # Step 7: Ëß£ÊûêÂπ∂ÂèëÂ∏ÉËØÑËÆ∫
      # ============================================================
      - name: Post review comments
        if: steps.check_perm.outputs.allowed == 'true'
        uses: actions/github-script@v7
        env:
          REVIEW_OUTPUT: ${{ steps.review.outputs.final-message }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const output = process.env.REVIEW_OUTPUT || '';
            const prNumber = parseInt(process.env.PR_NUMBER, 10);

            // Ê£ÄÊü•ÊòØÂê¶Êúâ API ÈîôËØØÔºàÂè™Ê£ÄÊµãË°åÈ¶ñÁöÑÁúüÊ≠£ÈîôËØØÊ†áËÆ∞ÔºåÈÅøÂÖçÂåπÈÖçÊ®°ÂûãÊÄùËÄÉÂÜÖÂÆπÔºâ
            const lines = output.split('\n');
            const errorLines = lines.filter(line => {
              const trimmed = line.trim();
              return trimmed.includes('No available providers') ||
                     trimmed.includes('Service Unavailable') ||
                     trimmed.match(/^ERROR:/i) ||
                     trimmed.match(/^mcp:.*failed/i) ||
                     trimmed.match(/^unexpected status (5\d\d|4\d\d)/i);
            });

            if (errorLines.length > 0) {
              console.log('API error detected:', errorLines.slice(0, 3).join('; '));
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## Code-Argus Review\n\n‚ùå **API Error**: The review service encountered an error.\n\n\`\`\`\n${errorLines.slice(0, 5).join('\n')}\n\`\`\`\n\nPlease check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\nComment \`code-argus review\` to retry.`
              });
              return;
            }

            let review;

            try {
              let jsonStr = null;

              // Method 1: Look for ```json code block
              const codeBlockMatch = output.match(/```json\s*([\s\S]*?)\s*```/);
              if (codeBlockMatch) {
                jsonStr = codeBlockMatch[1];
              }

              // Method 2: Find JSON after "codex" marker (Codex outputs multi-line formatted JSON)
              if (!jsonStr) {
                const codexMarkerIndex = output.lastIndexOf('codex\n');
                if (codexMarkerIndex > -1) {
                  const afterCodex = output.substring(codexMarkerIndex + 6).trim();
                  // Find the JSON object that starts with { and ends with }
                  const jsonStartIndex = afterCodex.indexOf('{');
                  if (jsonStartIndex > -1) {
                    // Find matching closing brace by counting braces
                    let braceCount = 0;
                    let jsonEndIndex = -1;
                    for (let i = jsonStartIndex; i < afterCodex.length; i++) {
                      if (afterCodex[i] === '{') braceCount++;
                      if (afterCodex[i] === '}') braceCount--;
                      if (braceCount === 0) {
                        jsonEndIndex = i + 1;
                        break;
                      }
                    }
                    if (jsonEndIndex > jsonStartIndex) {
                      jsonStr = afterCodex.substring(jsonStartIndex, jsonEndIndex);
                    }
                  }
                }
              }

              // Method 3: Fallback - find single-line JSON starting with {"summary"
              if (!jsonStr) {
                const lines = output.split('\n');
                for (let i = lines.length - 1; i >= 0; i--) {
                  const line = lines[i].trim();
                  if (line.startsWith('{"summary"')) {
                    jsonStr = line;
                    break;
                  }
                }
              }

              if (!jsonStr) {
                throw new Error('No JSON output found');
              }

              console.log('Found JSON string length:', jsonStr.length);
              review = JSON.parse(jsonStr);
              console.log('Parsed review:', JSON.stringify(review.summary));
            } catch (e) {
              console.log('Failed to parse JSON output:', e.message);
              console.log('Raw output (last 2000 chars):', output.slice(-2000));
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## Code-Argus Review\n\n‚ùå Failed to parse review output.\n\nPlease check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\nComment \`code-argus review\` to retry.`
              });
              return;
            }
            const severityEmoji = { high: 'üî¥', medium: 'üü°', low: 'üü¢' };

            // ÂèëÂ∏ÉË°åÂÜÖËØÑËÆ∫
            if (review.comments && review.comments.length > 0) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              const commitSha = pr.head.sha;

              for (const comment of review.comments) {
                const emoji = severityEmoji[comment.severity] || 'üü°';
                let body = `## ${emoji} [${comment.severity.toUpperCase()}] ${comment.title}\n\n`;
                body += `${comment.description}\n\n`;

                if (comment.suggestion) {
                  body += '```suggestion\n';
                  body += comment.suggestion;
                  if (!comment.suggestion.endsWith('\n')) body += '\n';
                  body += '```\n';
                }

                try {
                  await github.rest.pulls.createReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    commit_id: commitSha,
                    path: comment.file,
                    line: comment.line_end || comment.line_start,
                    start_line: comment.line_start !== comment.line_end ? comment.line_start : undefined,
                    body: body
                  });
                } catch (e) {
                  console.log(`Failed to post comment on ${comment.file}:${comment.line_start}: ${e.message}`);
                }
              }
            }

            // ÂèëÂ∏ÉÊÄªÁªìËØÑËÆ∫
            const summary = review.summary || { total_issues: 0, high: 0, medium: 0, low: 0, focus_areas: [] };
            let summaryBody = `## Code-Argus Review\n\n`;

            if (summary.total_issues === 0) {
              summaryBody += `Review completed. **No significant issues found.**\n\n`;
              summaryBody += `The changes look good from a correctness, security, and architecture perspective.\n`;
            } else {
              summaryBody += `Review completed. **${summary.total_issues}** suggestion(s) posted.\n\n`;
              summaryBody += `| Severity | Count |\n`;
              summaryBody += `|----------|-------|\n`;
              if (summary.high > 0) summaryBody += `| üî¥ High | ${summary.high} |\n`;
              if (summary.medium > 0) summaryBody += `| üü° Medium | ${summary.medium} |\n`;
              if (summary.low > 0) summaryBody += `| üü¢ Low | ${summary.low} |\n`;

              if (summary.focus_areas && summary.focus_areas.length > 0) {
                summaryBody += `\n**Focus areas**: ${summary.focus_areas.join(', ')}\n`;
              }
            }

            summaryBody += `\n---\n`;
            summaryBody += `Comment \`code-argus review\` to re-trigger review`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: summaryBody
            });

      # ============================================================
      # Step 8: ÈîôËØØÂ§ÑÁêÜ
      # ============================================================
      - name: Handle failure
        if: failure() && steps.check_perm.outputs.allowed == 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            if (!prNumber || isNaN(prNumber)) return;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## Code-Argus Review\n\n‚ùå Review failed. Please check the [workflow logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n\nComment \`code-argus review\` to retry.`
            });
