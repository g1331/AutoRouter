name: claude-codex-agent

on:
  issue_comment:
    types: [created]

jobs:
  handle-issue:
    if: contains(github.event.comment.body, '@autorouter-bot')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
      CODEX_BASE_URL: ${{ secrets.CODEX_BASE_URL }}
      AUGMENT_API_TOKEN: ${{ secrets.AUGMENT_API_TOKEN }}
      AUGMENT_API_URL: ${{ secrets.AUGMENT_API_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 22 (for auggie / npx MCPs)
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install uv (for uvx-based MCPs)
        run: |
          python -m pip install --user uv
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install auggie CLI (pre-release with MCP support)
        run: npm install -g @augmentcode/auggie@prerelease

      - name: Install Codex CLI
        run: npm install -g @openai/codex@latest

      - name: Configure Codex MCP servers
        env:
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          CODEX_BASE_URL: ${{ secrets.CODEX_BASE_URL }}
          CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
          AUGMENT_API_TOKEN: ${{ secrets.AUGMENT_API_TOKEN }}
          AUGMENT_API_URL: ${{ secrets.AUGMENT_API_URL }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          config = f"""
          [features]
          rmcp_client = true

          [mcp_servers.tavily-remote-mcp]
          url = "https://mcp.tavily.com/mcp/?tavilyApiKey={os.environ['TAVILY_API_KEY']}"

          [mcp_servers.context7]
          command = "npx"
          args = ["-y", "@upstash/context7-mcp"]

          [mcp_servers.code-index]
          command = "uvx"
          args = ["code-index-mcp"]

          [mcp_servers.codex]
          command = "uvx"
          args = ["--from", "git+https://github.com/GuDaStudio/codexmcp.git", "codexmcp"]
          env = {{ OPENAI_BASE_URL = "{os.environ['CODEX_BASE_URL']}", OPENAI_API_KEY = "{os.environ['CODEX_API_KEY']}" }}

          [mcp_servers.auggie-mcp]
          command = "auggie"
          args = ["--mcp"]
          env = {{ AUGMENT_API_TOKEN = "{os.environ['AUGMENT_API_TOKEN']}", AUGMENT_API_URL = "{os.environ['AUGMENT_API_URL']}" }}

          [mcp_servers.chrome-devtools]
          command = "npx"
          args = ["chrome-devtools-mcp@latest"]
          """

          cfg_dir = Path.home() / ".codex"
          cfg_dir.mkdir(parents=True, exist_ok=True)
          (cfg_dir / "config.toml").write_text(config.strip() + "\n", encoding="utf-8")
          PY

      - name: Write MCP config
        run: |
          cat <<'EOF' > .mcp.json
          {
            "mcpServers": {
              "tavily-remote-mcp": {
                "type": "http",
                "url": "https://mcp.tavily.com/mcp/?tavilyApiKey=${TAVILY_API_KEY}"
              },
              "context7": {
                "type": "stdio",
                "command": "npx",
                "args": [
                  "-y",
                  "@upstash/context7-mcp"
                ]
              },
              "code-index": {
                "type": "stdio",
                "command": "uvx",
                "args": [
                  "code-index-mcp"
                ]
              },
              "codex": {
                "type": "stdio",
                "command": "uvx",
                "args": [
                  "--from",
                  "git+https://github.com/GuDaStudio/codexmcp.git",
                  "codexmcp"
                ],
                "env": {
                  "OPENAI_BASE_URL": "${CODEX_BASE_URL}",
                  "OPENAI_API_KEY": "${CODEX_API_KEY}"
                }
              },
              "auggie-mcp": {
                "type": "stdio",
                "command": "auggie",
                "args": [
                  "--mcp"
                ],
                "env": {
                  "AUGMENT_API_TOKEN": "${AUGMENT_API_TOKEN}",
                  "AUGMENT_API_URL": "${AUGMENT_API_URL}"
                }
              },
              "chrome-devtools": {
                "type": "stdio",
                "command": "npx",
                "args": [
                  "chrome-devtools-mcp@latest"
                ]
              }
            }
          }
          EOF

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@autorouter-bot"
          claude_args: |
            --mcp-config .mcp.json
            --allowedTools mcp__tavily-remote-mcp,mcp__context7,mcp__code-index,mcp__codex,mcp__auggie-mcp,mcp__chrome-devtools,Edit,Replace,Bash(git:*,uv:*,npm:*,pnpm:*)
            --append-system-prompt "你是仓库专属机器人（中文沟通，代码/命令保持原文）。遵循高质量提示最佳实践：目标清晰、步骤化推理、示例/清单输出、允许承认不确定性。每次响应 @autorouter-bot 的评论时，请读取评论正文和上下文，确保：1) 先输出「需求摘要」「不确定点」「待确认清单」并在获得明确同意前仅提问；2) 如果评论描述的是 Bug，请依次使用 auggie → code-index → codex（必要时 tavily/context7）定位并给出「复现路径 / 根因定位 / 修复方案」三段说明，然后 @${{ github.event.issue.user.login }} 征求确认；3) 记录当前工作的分支、基点 commit，以及是否已有 fix/${{ github.event.issue.number }} 等分支需要继续使用；4) 获得确认后再改代码并运行相应测试/静态检查，完成后推送 PR 并附自检结果；5) 禁止在回复中泄露 tokens/花费/定价等信息；6) 在 PR 评论中再次被 @ 时，仅更新当前 PR 并同步最新自检。"
            --settings '{"alwaysThinkingEnabled":true}'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
