name: claude-codex-agent

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
  TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
  CODEX_API_KEY: ${{ secrets.CODEX_API_KEY }}
  CODEX_BASE_URL: ${{ secrets.CODEX_BASE_URL }}
  AUGMENT_API_TOKEN: ${{ secrets.AUGMENT_API_TOKEN }}
  AUGMENT_API_URL: ${{ secrets.AUGMENT_API_URL }}

jobs:
  # ============================================================
  # Job 1: 新issue深度分析（不自动修复，等待 /approve）
  # ============================================================
  triage:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Check if issue is still open
        id: check-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATE=$(gh issue view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json state --jq '.state')
          if [ "$STATE" != "OPEN" ]; then
            echo "Issue #${{ github.event.issue.number }} is $STATE, skipping"
            echo "is_open=false" >> $GITHUB_OUTPUT
          else
            echo "is_open=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-issue.outputs.is_open == 'true'
        uses: actions/checkout@v6

      - name: Setup Node 22 (for MCP servers)
        if: steps.check-issue.outputs.is_open == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install uv (for uvx-based MCPs)
        if: steps.check-issue.outputs.is_open == 'true'
        run: |
          python -m pip install --user uv
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install auggie CLI
        if: steps.check-issue.outputs.is_open == 'true'
        run: npm install -g @augmentcode/auggie@latest

      - name: Install Codex CLI
        if: steps.check-issue.outputs.is_open == 'true'
        run: npm install -g @openai/codex@latest

      - name: Configure Codex MCP servers
        if: steps.check-issue.outputs.is_open == 'true'
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          config = f"""
          [features]
          rmcp_client = true

          [mcp_servers.tavily-remote-mcp]
          url = "https://mcp.tavily.com/mcp/?tavilyApiKey={os.environ['TAVILY_API_KEY']}"

          [mcp_servers.context7]
          command = "npx"
          args = ["-y", "@upstash/context7-mcp"]

          [mcp_servers.code-index]
          command = "uvx"
          args = ["code-index-mcp"]

          [mcp_servers.auggie-mcp]
          command = "auggie"
          args = ["--mcp"]
          env = {{ AUGMENT_API_TOKEN = "{os.environ['AUGMENT_API_TOKEN']}", AUGMENT_API_URL = "{os.environ['AUGMENT_API_URL']}" }}

          [mcp_servers.chrome-devtools]
          command = "npx"
          args = ["chrome-devtools-mcp@latest", "--headless", "--no-sandbox", "--isolated=true"]
          """

          cfg_dir = Path.home() / ".codex"
          cfg_dir.mkdir(parents=True, exist_ok=True)
          (cfg_dir / "config.toml").write_text(config.strip() + "\n", encoding="utf-8")
          PY

      - name: Write MCP config
        if: steps.check-issue.outputs.is_open == 'true'
        id: mcp-config
        run: |
          MCP_JSON=$(cat <<EOF
          {
            "mcpServers": {
              "tavily-remote-mcp": {
                "type": "http",
                "url": "https://mcp.tavily.com/mcp/?tavilyApiKey=${TAVILY_API_KEY}"
              },
              "context7": {
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@upstash/context7-mcp"]
              },
              "code-index": {
                "type": "stdio",
                "command": "uvx",
                "args": ["code-index-mcp"]
              },
              "codex": {
                "type": "stdio",
                "command": "uvx",
                "args": ["--from", "git+https://github.com/GuDaStudio/codexmcp.git", "codexmcp"],
                "env": {
                  "OPENAI_BASE_URL": "${CODEX_BASE_URL}",
                  "OPENAI_API_KEY": "${CODEX_API_KEY}"
                }
              },
              "auggie-mcp": {
                "type": "stdio",
                "command": "auggie",
                "args": ["--mcp"],
                "env": {
                  "AUGMENT_API_TOKEN": "${AUGMENT_API_TOKEN}",
                  "AUGMENT_API_URL": "${AUGMENT_API_URL}"
                }
              },
              "chrome-devtools": {
                "type": "stdio",
                "command": "npx",
                "args": ["chrome-devtools-mcp@latest", "--headless", "--no-sandbox", "--isolated=true"]
              }
            }
          }
          EOF
          )
          echo "mcp_config=$(echo "$MCP_JSON" | jq -c .)" >> $GITHUB_OUTPUT

      - name: Configure Claude permissions
        if: steps.check-issue.outputs.is_open == 'true'
        timeout-minutes: 2
        run: |
          mkdir -p ~/.claude
          cat > ~/.claude/settings.json << 'EOF'
          {
            "permissions": {
              "allow": [
                "Bash(gh:*)",
                "Read",
                "Glob",
                "Grep",
                "WebSearch",
                "WebFetch",
                "Task",
                "TodoWrite",
                "mcp__tavily-remote-mcp__*",
                "mcp__context7__*",
                "mcp__code-index__*",
                "mcp__codex__*",
                "mcp__auggie-mcp__*",
                "mcp__chrome-devtools__*"
              ],
              "deny": []
            },
            "enableAllProjectMcpServers": true
          }
          EOF

      - name: Load prompt
        if: steps.check-issue.outputs.is_open == 'true'
        id: prompt
        run: |
          export ISSUE_NUMBER=${{ github.event.issue.number }}
          PROMPT=$(envsubst < .github/prompts/claude-agent/triage.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code for deep analysis
        if: steps.check-issue.outputs.is_open == 'true'
        timeout-minutes: 30
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          claude_args: --mcp-config '${{ steps.mcp-config.outputs.mcp_config }}'
          prompt: ${{ steps.prompt.outputs.content }}
          settings: '{"alwaysThinkingEnabled":true}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Job 2: 审批通过后自动开始工作
  # ============================================================
  auto-approve:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check if commenter is collaborator
        id: check-collaborator
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh api repos/${{ github.repository }}/collaborators/${{ github.actor }} --silent 2>/dev/null; then
            echo "is_collaborator=true" >> $GITHUB_OUTPUT
          else
            echo "is_collaborator=false" >> $GITHUB_OUTPUT
            echo "::warning::User ${{ github.actor }} is not a collaborator, ignoring /approve command"
          fi

      - name: Update labels on approval
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --remove-label "awaiting-approval" 2>/dev/null || true
          gh issue edit ${{ github.event.issue.number }} --remove-label "needs-info" 2>/dev/null || true
          gh issue edit ${{ github.event.issue.number }} --add-label "approved"
          gh issue edit ${{ github.event.issue.number }} --add-label "in-progress"

      - name: Setup Node 22 (for auggie / npx MCPs)
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install uv (for uvx-based MCPs)
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        run: |
          python -m pip install --user uv
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install auggie CLI
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        run: npm install -g @augmentcode/auggie@latest

      - name: Install Codex CLI
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        run: npm install -g @openai/codex@latest

      - name: Configure Codex MCP servers
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          config = f"""
          [features]
          rmcp_client = true

          [mcp_servers.tavily-remote-mcp]
          url = "https://mcp.tavily.com/mcp/?tavilyApiKey={os.environ['TAVILY_API_KEY']}"

          [mcp_servers.context7]
          command = "npx"
          args = ["-y", "@upstash/context7-mcp"]

          [mcp_servers.code-index]
          command = "uvx"
          args = ["code-index-mcp"]

          [mcp_servers.auggie-mcp]
          command = "auggie"
          args = ["--mcp"]
          env = {{ AUGMENT_API_TOKEN = "{os.environ['AUGMENT_API_TOKEN']}", AUGMENT_API_URL = "{os.environ['AUGMENT_API_URL']}" }}

          [mcp_servers.chrome-devtools]
          command = "npx"
          args = ["chrome-devtools-mcp@latest", "--headless", "--no-sandbox", "--isolated=true"]
          """

          cfg_dir = Path.home() / ".codex"
          cfg_dir.mkdir(parents=True, exist_ok=True)
          (cfg_dir / "config.toml").write_text(config.strip() + "\n", encoding="utf-8")
          PY

      - name: Write MCP config
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        id: mcp-config
        run: |
          # 生成 MCP 配置 JSON（使用实际环境变量值）
          MCP_JSON=$(cat <<EOF
          {
            "mcpServers": {
              "tavily-remote-mcp": {
                "type": "http",
                "url": "https://mcp.tavily.com/mcp/?tavilyApiKey=${TAVILY_API_KEY}"
              },
              "context7": {
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@upstash/context7-mcp"]
              },
              "code-index": {
                "type": "stdio",
                "command": "uvx",
                "args": ["code-index-mcp"]
              },
              "codex": {
                "type": "stdio",
                "command": "uvx",
                "args": ["--from", "git+https://github.com/GuDaStudio/codexmcp.git", "codexmcp"],
                "env": {
                  "OPENAI_BASE_URL": "${CODEX_BASE_URL}",
                  "OPENAI_API_KEY": "${CODEX_API_KEY}"
                }
              },
              "auggie-mcp": {
                "type": "stdio",
                "command": "auggie",
                "args": ["--mcp"],
                "env": {
                  "AUGMENT_API_TOKEN": "${AUGMENT_API_TOKEN}",
                  "AUGMENT_API_URL": "${AUGMENT_API_URL}"
                }
              },
              "chrome-devtools": {
                "type": "stdio",
                "command": "npx",
                "args": ["chrome-devtools-mcp@latest", "--headless", "--no-sandbox", "--isolated=true"]
              }
            }
          }
          EOF
          )
          # 压缩为单行并输出到 GITHUB_OUTPUT
          echo "mcp_config=$(echo "$MCP_JSON" | jq -c .)" >> $GITHUB_OUTPUT

      - name: Configure Claude permissions
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        timeout-minutes: 2
        run: |
          mkdir -p ~/.claude
          cat > ~/.claude/settings.json << 'EOF'
          {
            "permissions": {
              "allow": [
                "Bash",
                "Edit",
                "Write",
                "Read",
                "Glob",
                "Grep",
                "WebSearch",
                "WebFetch",
                "Task",
                "TodoWrite",
                "mcp__tavily-remote-mcp__*",
                "mcp__context7__*",
                "mcp__code-index__*",
                "mcp__codex__*",
                "mcp__auggie-mcp__*",
                "mcp__chrome-devtools__*"
              ],
              "deny": []
            },
            "enableAllProjectMcpServers": true
          }
          EOF

      - name: Load prompt
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        id: prompt
        run: |
          export ISSUE_NUMBER=${{ github.event.issue.number }}
          PROMPT=$(envsubst < .github/prompts/claude-agent/auto-approve.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code to fix issue
        if: steps.check-collaborator.outputs.is_collaborator == 'true'
        timeout-minutes: 120
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          branch_prefix: ""
          claude_args: --mcp-config '${{ steps.mcp-config.outputs.mcp_config }}'
          prompt: ${{ steps.prompt.outputs.content }}
          settings: '{"alwaysThinkingEnabled":true,"attribution":{"commit":"","pr":""}}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Append status on cancellation
        if: cancelled() && steps.check-collaborator.outputs.is_collaborator == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取最新的评论（由 bot 创建）
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '.[-1].id')

          # 获取现有评论内容
          CURRENT_BODY=$(gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            --jq -r '.body')

          # 追加取消状态
          gh api -X PATCH repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            -f body="${CURRENT_BODY}

          ---

          ⏸️ **工作流已取消** ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))

          工作流已被手动取消或超时（120分钟）。

          查看 [运行日志](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) 了解详情。"

          # 移除 in-progress 标签
          gh issue edit ${{ github.event.issue.number }} --remove-label "in-progress" 2>/dev/null || true

      - name: Append status on failure
        if: failure() && steps.check-collaborator.outputs.is_collaborator == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取最新的评论（由 bot 创建）
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '.[-1].id')

          # 获取现有评论内容
          CURRENT_BODY=$(gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            --jq -r '.body')

          # 追加失败状态
          gh api -X PATCH repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            -f body="${CURRENT_BODY}

          ---

          ❌ **操作失败** ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))

          工作流执行过程中遇到错误。

          查看 [运行日志](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) 了解详情。

          可能的原因：
          - MCP server 初始化失败
          - 代码执行错误
          - 测试失败"

          # 移除 in-progress 标签
          gh issue edit ${{ github.event.issue.number }} --remove-label "in-progress" 2>/dev/null || true

  # ============================================================
  # Job 3: 用户回复 needs-info 后重新分析
  # ============================================================
  handle-info-reply:
    if: |
      github.event_name == 'issue_comment' &&
      !contains(github.event.comment.body, '/approve') &&
      !contains(github.event.comment.body, '@autorouter-bot')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Check if issue has needs-info label
        id: check-label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABELS=$(gh issue view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "needs-info"; then
            echo "has_needs_info=true" >> $GITHUB_OUTPUT
          else
            echo "has_needs_info=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if commenter is issue author
        id: check-author
        run: |
          if [ "${{ github.event.comment.user.login }}" == "${{ github.event.issue.user.login }}" ]; then
            echo "is_author=true" >> $GITHUB_OUTPUT
          else
            echo "is_author=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-label.outputs.has_needs_info == 'true' && steps.check-author.outputs.is_author == 'true'
        uses: actions/checkout@v6

      - name: Load prompt
        if: steps.check-label.outputs.has_needs_info == 'true' && steps.check-author.outputs.is_author == 'true'
        id: prompt
        run: |
          export ISSUE_NUMBER=${{ github.event.issue.number }}
          PROMPT=$(envsubst < .github/prompts/claude-agent/handle-info-reply.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code to re-analyze
        if: steps.check-label.outputs.has_needs_info == 'true' && steps.check-author.outputs.is_author == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: ${{ steps.prompt.outputs.content }}
          claude_args: --allowedTools Bash(gh:*)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # Job 4: 手动 @autorouter-bot 触发
  # ============================================================
  manual:
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@autorouter-bot') &&
      !contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node 22 (for auggie / npx MCPs)
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Install uv (for uvx-based MCPs)
        run: |
          python -m pip install --user uv
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install auggie CLI
        run: npm install -g @augmentcode/auggie@latest

      - name: Install Codex CLI
        run: npm install -g @openai/codex@latest

      - name: Configure Codex MCP servers
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          config = f"""
          [features]
          rmcp_client = true

          [mcp_servers.tavily-remote-mcp]
          url = "https://mcp.tavily.com/mcp/?tavilyApiKey={os.environ['TAVILY_API_KEY']}"

          [mcp_servers.context7]
          command = "npx"
          args = ["-y", "@upstash/context7-mcp"]

          [mcp_servers.code-index]
          command = "uvx"
          args = ["code-index-mcp"]

          [mcp_servers.auggie-mcp]
          command = "auggie"
          args = ["--mcp"]
          env = {{ AUGMENT_API_TOKEN = "{os.environ['AUGMENT_API_TOKEN']}", AUGMENT_API_URL = "{os.environ['AUGMENT_API_URL']}" }}

          [mcp_servers.chrome-devtools]
          command = "npx"
          args = ["chrome-devtools-mcp@latest", "--headless", "--no-sandbox", "--isolated=true"]
          """

          cfg_dir = Path.home() / ".codex"
          cfg_dir.mkdir(parents=True, exist_ok=True)
          (cfg_dir / "config.toml").write_text(config.strip() + "\n", encoding="utf-8")
          PY

      - name: Write MCP config
        id: mcp-config
        run: |
          # 生成 MCP 配置 JSON（使用实际环境变量值）
          MCP_JSON=$(cat <<EOF
          {
            "mcpServers": {
              "tavily-remote-mcp": {
                "type": "http",
                "url": "https://mcp.tavily.com/mcp/?tavilyApiKey=${TAVILY_API_KEY}"
              },
              "context7": {
                "type": "stdio",
                "command": "npx",
                "args": ["-y", "@upstash/context7-mcp"]
              },
              "code-index": {
                "type": "stdio",
                "command": "uvx",
                "args": ["code-index-mcp"]
              },
              "codex": {
                "type": "stdio",
                "command": "uvx",
                "args": ["--from", "git+https://github.com/GuDaStudio/codexmcp.git", "codexmcp"],
                "env": {
                  "OPENAI_BASE_URL": "${CODEX_BASE_URL}",
                  "OPENAI_API_KEY": "${CODEX_API_KEY}"
                }
              },
              "auggie-mcp": {
                "type": "stdio",
                "command": "auggie",
                "args": ["--mcp"],
                "env": {
                  "AUGMENT_API_TOKEN": "${AUGMENT_API_TOKEN}",
                  "AUGMENT_API_URL": "${AUGMENT_API_URL}"
                }
              },
              "chrome-devtools": {
                "type": "stdio",
                "command": "npx",
                "args": ["chrome-devtools-mcp@latest", "--headless", "--no-sandbox", "--isolated=true"]
              }
            }
          }
          EOF
          )
          # 压缩为单行并输出到 GITHUB_OUTPUT
          echo "mcp_config=$(echo "$MCP_JSON" | jq -c .)" >> $GITHUB_OUTPUT

      - name: Configure Claude permissions
        timeout-minutes: 2
        run: |
          mkdir -p ~/.claude
          cat > ~/.claude/settings.json << 'EOF'
          {
            "permissions": {
              "allow": [
                "Bash",
                "Edit",
                "Write",
                "Read",
                "Glob",
                "Grep",
                "WebSearch",
                "WebFetch",
                "Task",
                "TodoWrite",
                "mcp__tavily-remote-mcp__*",
                "mcp__context7__*",
                "mcp__code-index__*",
                "mcp__codex__*",
                "mcp__auggie-mcp__*",
                "mcp__chrome-devtools__*"
              ],
              "deny": []
            },
            "enableAllProjectMcpServers": true
          }
          EOF

      - name: Load prompt
        id: prompt
        run: |
          export ISSUE_NUMBER=${{ github.event.issue.number }}
          PROMPT=$(envsubst < .github/prompts/claude-agent/manual.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        timeout-minutes: 120
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@autorouter-bot"
          claude_args: --mcp-config '${{ steps.mcp-config.outputs.mcp_config }}'
          prompt: ${{ steps.prompt.outputs.content }}
          settings: '{"alwaysThinkingEnabled":true,"attribution":{"commit":"","pr":""}}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Append status on cancellation
        if: cancelled()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取最新的评论（由 bot 创建）
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '.[-1].id')

          # 获取现有评论内容
          CURRENT_BODY=$(gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            --jq -r '.body')

          # 追加取消状态
          gh api -X PATCH repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            -f body="${CURRENT_BODY}

          ---

          ⏸️ **工作流已取消** ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))

          工作流已被手动取消或超时（120分钟）。

          查看 [运行日志](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) 了解详情。"

      - name: Append status on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取最新的评论（由 bot 创建）
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '.[-1].id')

          # 获取现有评论内容
          CURRENT_BODY=$(gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            --jq -r '.body')

          # 追加失败状态
          gh api -X PATCH repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
            -f body="${CURRENT_BODY}

          ---

          ❌ **操作失败** ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))

          工作流执行过程中遇到错误。

          查看 [运行日志](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) 了解详情。

          可能的原因：
          - MCP server 初始化失败
          - 代码执行错误
          - 测试失败"
